<a name="cAbwQ"></a>
## 队列配置：
`@Configuration<br />``public class ``RabbitConfig {`<br />`    ``public final static ``Logger ``_logger _``= LoggerFactory.``_getLogger_``(RabbitConfig.``class``)``;<br />``    ``@Autowired<br />``    ``CachingConnectionFactory ``cachingConnectionFactory``;<br />``    ``@Autowired<br />``    ``MailSendLogService ``mailSendLogService``;<br />``    ``@Bean<br />``    ``RabbitTemplate ``rabbitTemplate``() {`<br />`        RabbitTemplate rabbitTemplate = ``new ``RabbitTemplate(``cachingConnectionFactory``)``;<br />``        ``rabbitTemplate.setConfirmCallback((data``, ``ack``, ``cause) -> {`<br />`            String msgId = data.getId()``;<br />``            if ``(ack) {`<br />`                ``_logger_``.info(msgId + ``":``消息发送成功``"``)``;<br />``                ``mailSendLogService``.updateMailSendLogStatus(msgId``, ``1``)``;``//``修改数据库中的记录，消息投递成功<br />``            ``} ``else ``{`<br />`                ``_logger_``.info(msgId + ``":``消息发送失败``"``)``;<br />``            ``}`<br />`        })``;<br />``        ``rabbitTemplate.setReturnCallback((msg``, ``repCode``, ``repText``, ``exchange``, ``routingkey) -> {`<br />`            ``_logger_``.info(``"``消息发送失败``"``)``;<br />``        ``})``;<br />``        return ``rabbitTemplate``;<br />``    ``}`

`    ``@Bean<br />``    ``Queue ``mailQueue``() {`<br />`        ``return new ``Queue(MailConstants.``_MAIL_QUEUE_NAME_``, true``)``;<br />``    ``}`

`    ``@Bean<br />``    ``DirectExchange ``mailExchange``() {`<br />`        ``return new ``DirectExchange(MailConstants.``_MAIL_EXCHANGE_NAME_``, true, false``)``;<br />``    ``}`

`    ``@Bean<br />``    ``Binding ``mailBinding``() {`<br />`        ``return ``BindingBuilder.``_bind_``(mailQueue()).to(mailExchange()).with(MailConstants.``_MAIL_ROUTING_KEY_NAME_``)``;<br />``    ``}`

`}`

<a name="W5wA3"></a>
## 消息发送：
`public ``Integer ``addEmp``(Employee employee) {`<br />`    Date beginContract = employee.getBeginContract()``;<br />``    ``Date endContract = employee.getEndContract()``;<br />``    double ``month = (Double.``_parseDouble_``(``yearFormat``.format(endContract)) - Double.``_parseDouble_``(``yearFormat``.format(beginContract))) * ``12 ``+ (Double.``_parseDouble_``(``monthFormat``.format(endContract)) - Double.``_parseDouble_``(``monthFormat``.format(beginContract)))``;<br />``    ``employee.setContractTerm(Double.``_parseDouble_``(``decimalFormat``.format(month / ``12``)))``;<br />``    int ``result = ``employeeMapper``.insertSelective(employee)``;<br />``    if ``(result == ``1``) {`<br />`        Employee emp = ``employeeMapper``.getEmployeeById(employee.getId())``;<br />``        ``//``生成消息的唯一``id<br />``        ``String msgId = UUID.``_randomUUID_``().toString()``;<br />``        ``MailSendLog mailSendLog = ``new ``MailSendLog()``;<br />``        ``mailSendLog.setMsgId(msgId)``;<br />``        ``mailSendLog.setCreateTime(``new ``Date())``;<br />``        ``mailSendLog.setExchange(MailConstants.``_MAIL_EXCHANGE_NAME_``)``;<br />``        ``mailSendLog.setRouteKey(MailConstants.``_MAIL_ROUTING_KEY_NAME_``)``;<br />``        ``mailSendLog.setEmpId(emp.getId())``;<br />``        ``mailSendLog.setTryTime(``new ``Date(System.``_currentTimeMillis_``() + ``1000 ``* ``60 ``* MailConstants.``_MSG_TIMEOUT_``))``;<br />``        ``mailSendLogService``.insert(mailSendLog)``;<br />``        ``rabbitTemplate``.convertAndSend(MailConstants.``_MAIL_EXCHANGE_NAME_``, ``MailConstants.``_MAIL_ROUTING_KEY_NAME_``, ``emp``, new ``CorrelationData(msgId))``;<br />``    ``}`<br />`    ``return ``result``;<br />``}`
<a name="LdHWj"></a>
## 消息接受：
`@Component<br />``public class ``MailReceiver {`

`    ``public static final ``Logger ``_logger _``= LoggerFactory.``_getLogger_``(MailReceiver.``class``)``;<br />``    ``@Autowired<br />``    ``JavaMailSender ``javaMailSender``;<br />``    ``@Autowired<br />``    ``MailProperties ``mailProperties``;<br />``    ``@Autowired<br />``    ``TemplateEngine ``templateEngine``;<br />``    ``@Autowired<br />``    ``StringRedisTemplate ``redisTemplate``;<br />``    ``@RabbitListener``(queues = MailConstants.``_MAIL_QUEUE_NAME_``)`<br />`    ``public void ``handler``(Message message``, ``Channel channel) ``throws ``IOException {`<br />`        Employee employee = (Employee) message.getPayload()``;<br />``        ``MessageHeaders headers = message.getHeaders()``;<br />``        ``Long tag = (Long) headers.get(AmqpHeaders.``_DELIVERY_TAG_``)``;<br />``        ``String msgId = (String) headers.get(``"spring_returned_message_correlation"``)``;<br />``        if ``(``redisTemplate``.opsForHash().entries(``"mail_log"``).containsKey(msgId)) {`<br />`            ``//redis ``中包含该`` key``，说明该消息已经被消费过<br />``            ``_logger_``.info(msgId + ``":``消息已经被消费``"``)``;<br />``            ``channel.basicAck(tag``, false``)``;``//``确认消息已消费<br />``            ``return;<br />``        ``}`<br />`        ``//``收到消息，发送邮件<br />``        ``MimeMessage msg = ``javaMailSender``.createMimeMessage()``;<br />``        ``MimeMessageHelper helper = ``new ``MimeMessageHelper(msg)``;<br />``        try ``{`<br />`            helper.setTo(employee.getEmail())``;<br />``            ``helper.setFrom(``mailProperties``.getUsername())``;<br />``            ``helper.setSubject(``"``入职欢迎``"``)``;<br />``            ``helper.setSentDate(``new ``Date())``;<br />``            ``Context context = ``new ``Context()``;<br />``            ``context.setVariable(``"name"``, ``employee.getName())``;<br />``            ``context.setVariable(``"posName"``, ``employee.getPosition().getName())``;<br />``            ``context.setVariable(``"joblevelName"``, ``employee.getJobLevel().getName())``;<br />``            ``context.setVariable(``"departmentName"``, ``employee.getDepartment().getName())``;<br />``            ``String mail = ``templateEngine``.process(``"mail"``, ``context)``;<br />``            ``helper.setText(mail``, true``)``;<br />``            ``javaMailSender``.send(msg)``;<br />``            ``redisTemplate``.opsForHash().put(``"mail_log"``, ``msgId``, ``"javaboy"``)``;<br />``            ``channel.basicAck(tag``, false``)``;<br />``            ``_logger_``.info(msgId + ``":``邮件发送成功``"``)``;<br />``        ``} ``catch ``(MessagingException e) {`<br />`            channel.basicNack(tag``, false, true``)``;<br />``            ``e.printStackTrace()``;<br />``            ``_logger_``.error(``"``邮件发送失败：``" ``+ e.getMessage())``;<br />``        ``}`<br />`    }`<br />`}`
